---
title: "ENIGMA status"
format: 
  revealjs:
    footer: "ENIGMA - status"
    slide-number: c/t
    show-slide-number: all
    toc: true
    toc-title: "Overview"
    logo: images/dsc_hoved.png
    theme: solarized
editor: visual
---

# ENIGMA studiet

## Baggrund

-   Formålet er at undersøge kognitiv svækkelse efter stroke
-   Til undersøgelsen indgår MR, blodprøver, spørgeskemaer og kognitiv undersøgelse
-   Opfølgningsstudie over 12 måneder og med registerbaseret langtidsopfølgning
-   Mål om 150 patienter over 3,5 år
-   RESIST-patienter kan inkluderes - langtidsopfølgning

## Kriterier

| Inklusion       | Eksklusion                         |
|-----------------|------------------------------------|
| Personer ≥60 år | mRS \> 2                           |
| AIS eller TCI   | Konkurrerende livstruende sygdom   |
| MR-verificeret  | Anden betydelig neurologisk sygdom |
|                 | Skal selv gives samtykke           |
|                 | Skal tåle MR med kontrast          |
|                 | eGFR \< 30                        |

## Ny viden

- Småkarssygdom og kognitiv funktion
- Fysisk aktivitet og kognitiv funktion før/efter
- Perkonditionering og kognitivt outcome
- Tidligere opmærksomhed på tab af kognitiv funktion
- Mikrocirkulation ved AIS


# Status

## Inclusions

```{r}
library(tidyverse)
# remotes::install_github("agdamsbo/REDCapRITS")

library(gtsummary)
library(patchwork)
library(REDCapRITS)

# inst <-
  # REDCapR::redcap_instruments(redcap_uri = "https://redcap.au.dk/api/",
                              # token = keyring::key_get("enigma_api_key"))$data

d_list <- REDCapRITS::read_redcap_tables(
  uri = "https://redcap.au.dk/api/",
  token = keyring::key_get("enigma_api_key"),
  fields = c("record_id", "incl_by" , "incl_date"),
  forms = c(
    "klassifikation_af_primre_stroke",
    "baseline_stroke",
    "registrering",
    "baseline_nihss",
    "hjde_vgt_og_blodtryk",
    "rygeanamnese",
    "eos"
  )
) 
```

```{r}
redcap_wider <- function(list,glued="{.value}_{redcap_event_name}_long") {
  l <- lapply(list,function(i){
    incl <- any(duplicated(i[["record_id"]]))
    
    cname <- colnames(i)
    vals <- cname[!cname%in%c("record_id","redcap_event_name")]
    
    i$redcap_event_name <- tolower(gsub(" ","_",i$redcap_event_name))
    
    if (incl){
    s <- pivot_wider(i,
            names_from = redcap_event_name,
            values_from = all_of(vals),
            names_glue = glued)
    s[colnames(s)!="redcap_event_name"]
    } else (i[colnames(i)!="redcap_event_name"])
    
    })

  ## Additional conditioning is needed to handle repeated instruments.
  
  Reduce(f = full_join, x = l)
}
```

```{r}
d <- redcap_wider(d_list)
```

```{r}
source("/Users/au301842/ENIGMAtrial_R/src/status_plot.R")
```

```{r inclusion}
p1
```

## Baseline data {.smaller}

```{r baseline}
d |>
  select(age,
         kon,
         civil,
         hypertension,
         diabetes,
         resist_incl,
         nihss_baseline_sum) |>
  mutate(
    hypertension = hypertension != "Nej",
    diabetes = diabetes != "Nej",
    resist_incl = resist_incl == "Ja",
    civil = civil == "Bor alene"
  ) |>
  tbl_summary(
    by = "kon",
    missing = "ifany",
    label = list(
      nihss_baseline_sum ~ "NIHSS at admission",
      civil ~ "Living alone",
      resist_incl ~ "RESIST participant"
    )
  ) |>
  add_overall()
```

## TOAST classification {.smaller}

```{r toast}
d |>
  select(kon, class_toast,
         ) |>
  tbl_summary(
    by = "kon",
    missing = "ifany",
    missing_text = "Not classified",
    label = list(
      class_toast ~ "TOAST classification"
    )
  ) |>
  add_overall()
```

## End of Study {.smaller}

```{r eos}
d |>
  select(kon, eos2, eos3) |>
  mutate(eos2 = eos2,
         eos3 = factor(
           eos3,
           labels = c("Other diagnose", "Lost to follow-up", "Dead", "Retracted consent")
         )) |>
  tbl_summary(
    by = "kon",
    missing = "ifany",
    missing_text = "(Missing data)",
    label = list(
      eos2 ~ "Completed",
      eos3 ~ "Reason")
  ) |>
  add_overall()
```


## RESIST {.smaller}

```{r resist}
d |>
  select(resist_incl, eos2, eos3) |>
  mutate(eos2 = eos2,
         eos3 = factor(
           eos3,
           labels = c("Other diagnose", "Lost to follow-up", "Dead", "Retracted consent")
         )) |>
  tbl_summary(
    by = "resist_incl",
    missing = "ifany",
    missing_text = "(Missing data)",
    label = list(
      eos2 ~ "Completed",
      eos3 ~ "Reason")
  ) |>
  add_overall()
```
