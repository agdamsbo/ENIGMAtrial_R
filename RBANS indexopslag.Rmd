---
title: "RBANS index score calculator"
author: "Andreas Gammelgaard Damsbo"
date: "3/15/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(readxl)
```

# Importing index tables

## Writing funtion
Function imports tables
```{r}
list_tables<-function(table_paths,sheets){
  # Sheets denotes the number of sheets to import. At the moment only the amount can be specified, not a range or specific sheets. Its on the list!
  require(readxl)
  
paths<-table_paths
tbls<-list()
table_names<-c()

for(i in 1:length(paths)){
  path<-paths[i]
  table_name<-paste0("index_",unlist(strsplit(rev(unlist(strsplit(paths[i], "[/]")))[1], "[.]"))[1])
  table_names<-c(table_names,table_name)
  index_domain<-list()
  for(x in 1:sheets) {
      shts<-1:sheets
      index_domain[[excel_sheets(path)[x]]] <- data.frame(read_excel(path=path, sheet=shts[x]))
      # The import function guesses the data type. If clear definition is needed, this can be used:
      # ,col_types = c("numeric","numeric","text","text","text","text")
      # In R version >4 stringAsfactor is FALSE as default.
      # The "read_excel" also works with both .xls and .xlsx. The first is much faster though!
      
      }
  tbls<-append(tbls,list(index_domain))
}
names(tbls)<-table_names

return(tbls)
}
```

## Creating a list of imported lists
```{r}
index_tables<-list_tables(c("/Users/andreas/Documents/Læge/Forskning/PhD/ENIGMA/RBANS/RBANS_index_tables/2039.xlsx",
                            "/Users/andreas/Documents/Læge/Forskning/PhD/ENIGMA/RBANS/RBANS_index_tables/4049.xlsx",
                            "/Users/andreas/Documents/Læge/Forskning/PhD/ENIGMA/RBANS/RBANS_index_tables/5059.xlsx",
                            "/Users/andreas/Documents/Læge/Forskning/PhD/ENIGMA/RBANS/RBANS_index_tables/6069.xlsx",
                            "/Users/andreas/Documents/Læge/Forskning/PhD/ENIGMA/RBANS/RBANS_index_tables/7079.xlsx",
                            "/Users/andreas/Documents/Læge/Forskning/PhD/ENIGMA/RBANS/RBANS_index_tables/8089.xlsx"),sheets=5)
index_tables<-append(index_tables,list_tables("/Users/andreas/Documents/Læge/Forskning/PhD/ENIGMA/RBANS/RBANS_index_tables/scale_total.xlsx",sheets=1))
```

# Calculating the index scores

## Creating a test dataset

```{r}
var_names=c("a","b","c","d","e")
parts=10

dta<-data.frame(id=1:parts,age=as.numeric(sample(18:39,10)),matrix(sample(20:40,replace=TRUE), ncol = length(var_names), nrow = parts,dimnames=list(NULL,var_names)),version="a")
```

## Categorising patients according to index table
```{r}
ndx_nms<-c("index_2039","index_4049","index_5059","index_6069","index_7079","index_8089")
# should be changed to this: names(index_tables)

dta$index_c<-ifelse(dta$age>17&dta$age<40,ndx_nms[1],
                           ifelse(dta$age>39&dta$age<50,ndx_nms[2],
                                  ifelse(dta$age>49&dta$age<60,ndx_nms[3],
                                         ifelse(dta$age>59&dta$age<70,ndx_nms[4],
                                                ifelse(dta$age>69&dta$age<80,ndx_nms[5],
                                                       ifelse(dta$age>79,ndx_nms[6],NA))))))

```

## Formatting scale_total
```{r}
## Function to extend written intervals in cells to "long" format by repeating associated variables. Used to extend index tables.

interval_extention<-function(dtfrm){
  dta<-dtfrm
df<-data.frame(rbind(1:ncol(dta)))[0,]
cnms<-colnames(dta)
colnames(df)<-cnms

for (t in 1:nrow(dta)){
  nd<-as.numeric(unlist(strsplit(dta[1][t,], "[-]")))
  one<-c(nd[1]:nd[2])
  dt<-df
  for (r in 1:length(one)){
    dtt<-cbind(one[r],dta[-1][t,])
    colnames(dtt)<-cnms
    dt<-rbind(dt,dtt)
  }
  dt<-data.frame(c(nd[1]:nd[2]),dta[2][t,],dta[3][t,],dta[4][t,],dta[5][t,])
  colnames(dt)<-cnms
  df<-rbind(df,dt)
}
return(df)
}
```


```{r}
index_tables$index_hele_skala$scale_total<-interval_extention(index_tables$index_hele_skala$scale_total)
```



## Defining function to calculate index scores
```{r}
# index_from_raw<-function(dta,table_list){
df<-data.frame(matrix(1:7,ncol=7,nrow = nrow(dta),byrow = T))
  colnames(df)<-c("a_i","b_i","c_i","d_i","e_i","total","total_i")
  # df<-df[0,]
  dt<-dta
  
  clnms<-c("a","b","c","d","e")
for (i in 1:nrow(dta)){
  # i=2
  
  ## Selecting tables based on age
  lst<-index_tables[dt$index_c[i]]
  
  version<-"a"
  ## should be dependent on variable
  
  # A
  sht=1
  df$a_i[i]<-lst[[1]][[sht]]$indexscore[lst[[1]][[sht]]$total_rawscore==dt[i,clnms[sht]]&lst[[1]][[sht]]$version==version]
  
  # B
  sht=2
  df$b_i[i]<-lst[[1]][[sht]]$indexscore[lst[[1]][[sht]]$total_rawscore==dt[i,clnms[sht]]&lst[[1]][[sht]]$version==version]
  
  # C
  sht=3
  df$c_i[i]<-lst[[1]][[sht]]$indexscore[lst[[1]][[sht]]$total_rawscore==dt[i,clnms[sht]]&lst[[1]][[sht]]$version==version]
  
  # D
  sht=4
  df$d_i[i]<-lst[[1]][[sht]]$indexscore[lst[[1]][[sht]]$total_rawscore==dt[i,clnms[sht]]&lst[[1]][[sht]]$version==version]
  
  # E
  sht=5
  df$e_i[i]<-lst[[1]][[sht]]$indexscore[lst[[1]][[sht]]$total_rawscore==dt[i,clnms[sht]]&lst[[1]][[sht]]$version==version]
  
  # Total
  df$total[i]<-sum(df[i,1:5])
  
  ## Total index lookup
  df_scale<-index_tables[[length(index_tables)]][[1]]
  df$total_i[i]<-df_scale[2][df_scale[1]==df$total[i]]
}
#   return(df)
# }
```












