---
title: "PASE"
author: "Andreas Gammelgaard Damsbo"
date: "Knitted: `r format(Sys.time(), '%d %B %Y')`"
output:
  pdf_document: default
  html_document: default
toc: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(haven)
library(dplyr)
library(reshape2)
```


```{r}
pase<-read.csv("/Users/andreas/ENIGMAtrial_R/pase_all.csv")
pase_old<-read.csv("/Users/andreas/ENIGMAtrial_R/pase_old_sum.csv")
```

# Recode item 2-6

```{r}
reco.multi.26<-function(dat,ends_w){
  require(dplyr)
  df<-select(dat,ends_with(ends_w))
  
  reco<-function(var){
  c<-c()
for(i in 1:length(var)){
  c<-c(c,switch(var[i],"0"=0,"1"=1.5,"2"=3.5,"3"=6,0))}
  return(c)
  }
  
  d<-data.frame(df[[1]])
  for(t in 1:ncol(df)){
    d<-data.frame(d,reco(as.character(df[[t]])))
  }
  d<-d[,-1]
  colnames(d)<-paste0("Q",ends_w)
  return(d)
}
```


```{r}
reco.multi.26b<-function(dat,ends_w){
  require(dplyr)
  df<-select(dat,ends_with(ends_w))
  
  reco<-function(var){
  c<-c()
for(i in 1:length(var)){
  c<-c(c,switch(var[i],"1"=.5,"2"=1.5,"3"=3,"4"=5,0))}
  return(c)
  }
  
  d<-data.frame(df[[1]])
  for(t in 1:ncol(df)){
    d<-data.frame(d,reco(as.character(df[[t]])))
  }
  d<-d[,-1]
  colnames(d)<-paste0("Q",ends_w)
  return(d)
}
```

```{r}
q26<-reco.multi.26(pase,c("02","03","04","05","06"))*reco.multi.26b(pase,c("02a","03b","04b","05b","06b"))/7
```

# Recode 7-9d
```{r}
reco.multi.79d<-function(dat,ends_w){
  require(dplyr)
  df<-select(dat,ends_with(ends_w))
  
  reco<-function(var){
  c<-c()
for(i in 1:length(var)){
  c<-c(c,switch(var[i],"1"=1,"2"=0,0))}
  return(c)
  }
  
  d<-data.frame(df[[1]])
  for(t in 1:ncol(df)){
    d<-data.frame(d,reco(as.character(df[[t]])))
  }
  d<-d[,-1]
  colnames(d)<-paste0("Q",ends_w)
  return(d)
}
```

```{r}
q79d<-reco.multi.79d(pase,c("07","08","09a","09b","09c","09d"))
```

# Recode Q10
```{r}
q10<-ifelse(pase$TALOS_PASE10==1,pase$TALOS_PASE10a/7,0)
```

# Calculate score
```{r}
qall<-cbind(q26,q79d,q10)
```

```{r}
pase.calc.sum<-function(dat,facts=c(20,21,23,23,30,25,25,30,36,20,35,21),dec=2){
  d<-data.frame(dat[[1]])
  names<-names(dat)
for(r in 1:ncol(dat)){
  d<-data.frame(d,dat[[r]]*facts[r])}
  d<-d[,-1]
  colnames(d)<-names
  d$sum<-round(rowSums(d),dec)
  return(d)
}
```

```{r}
pase_new<-pase.calc.sum(qall,dec=2)
```

# Compare old to new method
```{r}
comp<-cbind(pase_old,pase_new)[abs(pase_old$score_total-pase_new$sum)>40,]
nrow(comp[!is.na(comp[1]),])
show(comp[!is.na(comp[1]),])
```

```{r}
n=16
show(cbind(pase_old,pase_new)[n,])
pase[n,]
```

## Notes on differences
- Old version uses weights from table, new version calculates as described in appendix c from the original manual. This only has a very minor, non-important effect.
- Old version leaves item 10 out, if 10b is missing. This leaves a few case with very big difference. Does not matter.
- In the old version, there are two mistakes in the code. They have not been corrected in the original code.
  1: If 3. Often and 1. Less than..., the factor is set at .42, and should be .43. This has a non-important effect.
  2: If 3. Often and 3. 2-4 hours, the factor is set at 3.57, and should be 2.57. This affects n=274 (see code below). This have resulted in an additional score of 20-30 points. This may have affected results, and should be tested.
- In total n=24 tests have more than 40 points in difference between methods. This probably does not matter.

```{r}
sum(nrow(pase[pase$TALOS_PASE02==3&pase$TALOS_PASE02b==3,]),
    nrow(pase[pase$TALOS_PASE03==3&pase$TALOS_PASE03b==3,]),
    nrow(pase[pase$TALOS_PASE04==3&pase$TALOS_PASE04b==3,]),
    nrow(pase[pase$TALOS_PASE05==3&pase$TALOS_PASE05b==3,]),
    nrow(pase[pase$TALOS_PASE06==3&pase$TALOS_PASE06b==3,])
    )
```


# Export
```{r}
# write.csv(pase_c,"/Volumes/Data/cognition/source/pase.csv",row.names = FALSE)
```
